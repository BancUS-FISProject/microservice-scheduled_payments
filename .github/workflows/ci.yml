name: CI

on:
  push:
  pull_request:

jobs:
  test-build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # --------------------
      # Python setup
      # --------------------
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install Python deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Compile (python -m compileall)
        run: |
          python -m compileall -q src/scheduled_payments

      # --------------------
      # Node + Jest deps
      # --------------------
      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install JS test deps
        run: |
          npm ci || npm install

      # --------------------
      # In-process tests
      # --------------------
      - name: Start CI dependencies (mongo + mocks)
        run: |
          docker compose -f docker-compose.ci.yml up -d
          docker ps

      - name: Wait for mocks (CI)
        run: |
          for i in $(seq 1 60); do
            curl -fsS http://localhost:8001/v1/account/ES_BASIC_123 >/dev/null && break
            sleep 1
          done
          for i in $(seq 1 60); do
            curl -fsS -X POST http://localhost:8002/v1/transactions \
              -H "Content-Type: application/json" \
              -d '{"sender":"A","receiver":"B","quantity":1,"currency":"EUR"}' >/dev/null && break
            sleep 1
          done

      - name: Run Jest (in-process)
        run: |
          npm run test:inprocess

      - name: Stop CI dependencies
        if: always()
        run: |
          docker compose -f docker-compose.ci.yml down -v

      # --------------------
      # Build Docker image
      # --------------------
      - name: Build Docker image
        run: |
          docker build -t scheduled-payments:ci .

      # --------------------
      # Out-of-process tests (container)
      # --------------------
      - name: Start E2E stack (includes scheduled-payments container)
        run: |
          docker compose -f docker-compose.e2e.yml up -d
          docker ps

      - name: Run Jest (out-of-process)
        run: |
          npm run test:outprocess

      - name: Stop E2E stack
        if: always()
        run: |
          docker compose -f docker-compose.e2e.yml down -v
